language: go
sudo: false
go:
- 1.15.2
os: linux
dist: focal
services:
- postgresql
addons:
  ssh_known_hosts: 95.163.209.195
  postgresql: '10'
  apt:
    packages:
    - postgresql
    - postgresql-client
install:
- go get -u -t -v ./...
before_script:
- sudo service postgresql start
- psql -c 'create database maila;' -U postgres
- psql -c "ALTER USER postgres WITH PASSWORD '987654321';" -U postgres
- curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh
    | sh -s -- -b $(go env GOPATH)/bin $GOLANGCI_LINT_VERSION

before_install:
- pwd
- ls
- openssl aes-256-cbc -K $encrypted_a626daabe3df_key -iv $encrypted_a626daabe3df_iv
  -in .travis/deploy_key.enc -out .travis/deploy_key -d
- chmod 600 ${TRAVIS_BUILD_DIR}/.travis/deploy_key


before_deploy:
- echo before Deploy
- cd ..
- pwd
- mv ${TRAVIS_BUILD_DIR}/.travis/deploy_key ~/.ssh/id_rsa
- cat ${TRAVIS_BUILD_DIR}/.travis/ssh_config >> ~/.ssh/config
script:
- pwd
- go mod vendor
- golangci-lint run
- echo TRAIS BULD DIR
- echo $TRAVIS_BUILD_DIR
- ./cmd/runFileServiceTest.sh
- ./cmd/runMailServiceTest.sh
- ./cmd/runMainApplicationTest.sh
- ./cmd/runUserServiceTest.sh

deploy:
  cleanup: true
  provider: script
  script:
     ./.travis/deploy.sh
  on:
    branch: CI
